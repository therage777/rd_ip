server {
    listen 80;
    server_name rdips.waba88.com;
    
    # HTTPS로 리다이렉트 (권장)
    # return 301 https://$server_name$request_uri;
    
    index index.php;
    root /home/www/rd_ip;
    
    # 보안 헤더
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
    
    # 디렉토리 인덱싱 비활성화
    autoindex off;
    
    # 클라이언트 요청 크기 제한
    client_max_body_size 2M;
    client_body_buffer_size 128k;
    
    # 타임아웃 설정
    client_body_timeout 10;
    client_header_timeout 10;
    keepalive_timeout 5 5;
    send_timeout 10;
    
    # 중요 파일 접근 차단
    location ~ /\.(ht|git|svn) {
        deny all;
        return 404;
    }
    
    # 설정 파일 접근 차단
    location ~ ^/(config\.php|security\.php|lib\.php|composer\.(json|lock)|package\.(json|lock)|README\.md|INSTALL\.md|SECURITY\.md|schema.*\.sql)$ {
        deny all;
        return 404;
    }
    
    # vendor 디렉토리 차단
    location ^~ /vendor/ {
        deny all;
        return 404;
    }
    
    # agent 디렉토리 차단
    location ^~ /agent/ {
        deny all;
        return 404;
    }
    
    # script 디렉토리 차단
    location ^~ /script/ {
        deny all;
        return 404;
    }
    
    # logs 디렉토리 차단
    location ^~ /logs/ {
        deny all;
        return 404;
    }
    
    # API 파일 - POST만 허용
    location ~ ^/api_.*\.php$ {
        if ($request_method !~ ^(POST)$ ) {
            return 405;
        }
        
        fastcgi_pass unix:/tmp/php-cgi.sock;
        fastcgi_index index.php;
        include fastcgi.conf;
        include pathinfo.conf;
        
        # API 요청 제한 (브루트포스 방지)
        limit_req zone=api burst=10 nodelay;
    }
    
    # 로그인 페이지 요청 제한
    location = /login.php {
        # 로그인 시도 제한 (브루트포스 방지)
        limit_req zone=login burst=5 nodelay;
        
        fastcgi_pass unix:/tmp/php-cgi.sock;
        fastcgi_index index.php;
        include fastcgi.conf;
        include pathinfo.conf;
    }
    
    # PHP 파일 처리
    location ~ [^/]\.php(/|$) {
        fastcgi_pass unix:/tmp/php-cgi.sock;
        fastcgi_index index.php;
        include fastcgi.conf;
        include pathinfo.conf;
    }
    
    # 정적 파일 캐싱
    location ~ .*\.(gif|jpg|jpeg|png|bmp|swf|ico)$ {
        expires 30d;
        access_log off;
    }
    
    location ~ .*\.(js|css)$ {
        expires 12h;
        access_log off;
    }
    
    # 기타 파일 차단
    location ~ \.(sql|log|sh|py|md|yml|yaml|env|bak|backup|old)$ {
        deny all;
        return 404;
    }
    
    # 루트 디렉토리
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }
    
    # 에러 페이지
    error_page 403 404 /error.php;
    error_page 500 502 503 504 /error.php;
    
    # 로그 설정
    access_log /home/wwwlogs/rdips.waba88.com.log;
    error_log /home/wwwlogs/rdips.waba88.com.error.log warn;
}

# HTTPS 설정 (SSL 인증서 설치 후 활성화)
# server {
#     listen 443 ssl http2;
#     server_name rdips.waba88.com;
#     
#     ssl_certificate /path/to/certificate.crt;
#     ssl_certificate_key /path/to/private.key;
#     
#     # SSL 보안 설정
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers HIGH:!aNULL:!MD5;
#     ssl_prefer_server_ciphers on;
#     ssl_session_cache shared:SSL:10m;
#     ssl_session_timeout 10m;
#     
#     # HSTS (1년)
#     add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
#     
#     # 나머지 설정은 위의 HTTP 블록과 동일
#     # ...
# }