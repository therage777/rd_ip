<?php require __DIR__ . '/config.php'; ?>
<!doctype html>
<html lang="ko">
<meta charset="utf-8">
<title>FW 관리</title>

<body style="font-family:system-ui;margin:20px">
    <h2>Firewall 관리 (Redis → ipset/iptables)</h2>

    <section style="margin-bottom:20px">
        <h3>IP 차단/해제</h3>
        <form method="post" action="api_add_ip.php" onsubmit="return confirm('차단?')">
            IP: <input name="ip" required>
            메모: <input name="comment" size="40">
            <input type="hidden" name="token" value="<?php echo htmlspecialchars(API_TOKEN, ENT_QUOTES, 'UTF-8'); ?>">
            <button>차단(ban_ip)</button>
        </form>
        <form method="post" action="api_del_ip.php" onsubmit="return confirm('해제?')">
            IP: <input name="ip" required>
            메모: <input name="comment" size="40">
            <input type="hidden" name="token" value="<?php echo htmlspecialchars(API_TOKEN, ENT_QUOTES, 'UTF-8'); ?>">
            <button>해제(unban_ip)</button>
        </form>
    </section>

    <section style="margin-bottom:20px">
        <h3>포트 차단/해제</h3>
        <form method="post" action="api_block_port.php" onsubmit="return confirm('포트 차단?')">
            Port: <input name="port" type="number" min="1" max="65535" required>
            메모: <input name="comment" size="40">
            <input type="hidden" name="token" value="<?php echo htmlspecialchars(API_TOKEN, ENT_QUOTES, 'UTF-8'); ?>">
            <button>차단(block_port)</button>
        </form>
        <form method="post" action="api_unblock_port.php" onsubmit="return confirm('포트 해제?')">
            Port: <input name="port" type="number" min="1" max="65535" required>
            메모: <input name="comment" size="40">
            <input type="hidden" name="token" value="<?php echo htmlspecialchars(API_TOKEN, ENT_QUOTES, 'UTF-8'); ?>">
            <button>해제(unblock_port)</button>
        </form>
    </section>

    <section style="margin-bottom:20px">
        <h3>IP:PORT 허용/해제 &amp; 차단/해제</h3>

        <!-- IP:PORT 허용 (화이트리스트) -->
        <form method="post" action="api_allow_ipport.php" onsubmit="return confirm('IP:PORT 허용?')">
            IP: <input name="ip" required>
            Port: <input name="port" type="number" min="1" max="65535" required>
            메모: <input name="comment" size="40">
            <input type="hidden" name="token" value="<?php echo htmlspecialchars(API_TOKEN, ENT_QUOTES, 'UTF-8'); ?>">
            <button>허용(allow_ipport)</button>
        </form>

        <!-- IP:PORT 허용 해제 -->
        <form method="post" action="api_unallow_ipport.php" onsubmit="return confirm('IP:PORT 허용 해제?')">
            IP: <input name="ip" required>
            Port: <input name="port" type="number" min="1" max="65535" required>
            메모: <input name="comment" size="40">
            <input type="hidden" name="token" value="<?php echo htmlspecialchars(API_TOKEN, ENT_QUOTES, 'UTF-8'); ?>">
            <button>허용 해제(unallow_ipport)</button>
        </form>

        <!-- IP:PORT 차단 (블랙리스트) -->
        <form method="post" action="api_block_ipport.php" onsubmit="return confirm('IP:PORT 차단?')">
            IP: <input name="ip" required>
            Port: <input name="port" type="number" min="1" max="65535" required>
            메모: <input name="comment" size="40">
            <input type="hidden" name="token" value="<?php echo htmlspecialchars(API_TOKEN, ENT_QUOTES, 'UTF-8'); ?>">
            <button>차단(block_ipport)</button>
        </form>

        <!-- IP:PORT 차단 해제 -->
        <form method="post" action="api_unblock_ipport.php" onsubmit="return confirm('IP:PORT 차단 해제?')">
            IP: <input name="ip" required>
            Port: <input name="port" type="number" min="1" max="65535" required>
            메모: <input name="comment" size="40">
            <input type="hidden" name="token" value="<?php echo htmlspecialchars(API_TOKEN, ENT_QUOTES, 'UTF-8'); ?>">
            <button>차단 해제(unblock_ipport)</button>
        </form>
    </section>

    <section style="margin-bottom:20px">
        <h3>현재 차단 목록</h3>
        <button onclick="load()">새로고침</button>
        
        <!-- IP 차단 목록 -->
        <div style="margin-top:15px">
            <h4>차단된 IP 목록</h4>
            <div id="blocked-ips" style="background:#f6f6f6;padding:10px;min-height:50px"></div>
        </div>
        
        <!-- 포트 차단 목록 -->
        <div style="margin-top:15px">
            <h4>차단된 포트 목록</h4>
            <div id="blocked-ports" style="background:#f6f6f6;padding:10px;min-height:50px"></div>
        </div>
        
        <!-- IP:PORT 차단 목록 -->
        <div style="margin-top:15px">
            <h4>차단된 IP:PORT 목록</h4>
            <div id="blocked-ipports" style="background:#f6f6f6;padding:10px;min-height:50px"></div>
        </div>
    </section>
    
    <section>
        <h3>전체 데이터 (JSON)</h3>
        <pre id="out" style="background:#f6f6f6;padding:10px"></pre>
    </section>

    <script>
        function load() {
            fetch('api_list.php').then(r => r.json()).then(j => {
                // JSON 데이터 표시
                document.getElementById('out').textContent = JSON.stringify(j, null, 2);
                
                // IP 차단 목록 표시
                const ipsDiv = document.getElementById('blocked-ips');
                if (j.black_ips && j.black_ips.length > 0) {
                    ipsDiv.innerHTML = j.black_ips.map(ip => 
                        `<div style="margin:5px 0;display:flex;align-items:center;justify-content:space-between;">
                            <span>${ip}</span>
                            <button onclick="unbanIP('${ip}')" style="background:#dc3545;color:white;border:none;padding:5px 10px;cursor:pointer;border-radius:3px">해제</button>
                        </div>`
                    ).join('');
                } else {
                    ipsDiv.innerHTML = '<span style="color:#999">차단된 IP가 없습니다.</span>';
                }
                
                // 포트 차단 목록 표시
                const portsDiv = document.getElementById('blocked-ports');
                if (j.block_ports && j.block_ports.length > 0) {
                    portsDiv.innerHTML = j.block_ports.map(port => 
                        `<div style="margin:5px 0;display:flex;align-items:center;justify-content:space-between;">
                            <span>포트 ${port}</span>
                            <button onclick="unblockPort(${port})" style="background:#dc3545;color:white;border:none;padding:5px 10px;cursor:pointer;border-radius:3px">해제</button>
                        </div>`
                    ).join('');
                } else {
                    portsDiv.innerHTML = '<span style="color:#999">차단된 포트가 없습니다.</span>';
                }
                
                // IP:PORT 차단 목록 표시
                const ipportsDiv = document.getElementById('blocked-ipports');
                if (j.block_ipports && j.block_ipports.length > 0) {
                    ipportsDiv.innerHTML = j.block_ipports.map(ipport => {
                        const [ip, port] = ipport.split(':');
                        return `<div style="margin:5px 0;display:flex;align-items:center;justify-content:space-between;">
                            <span>${ip}:${port}</span>
                            <button onclick="unblockIPPort('${ip}', '${port}')" style="background:#dc3545;color:white;border:none;padding:5px 10px;cursor:pointer;border-radius:3px">해제</button>
                        </div>`;
                    }).join('');
                } else {
                    ipportsDiv.innerHTML = '<span style="color:#999">차단된 IP:PORT가 없습니다.</span>';
                }
                
            }).catch(e => alert(e));
        }
        
        // IP 차단 해제
        function unbanIP(ip) {
            if (!confirm(`IP ${ip}를 차단 해제하시겠습니까?`)) return;
            
            const formData = new FormData();
            formData.append('ip', ip);
            formData.append('comment', '원클릭 해제');
            formData.append('token', '<?php echo htmlspecialchars(API_TOKEN, ENT_QUOTES, 'UTF-8'); ?>');
            
            fetch('api_del_ip.php', {
                method: 'POST',
                body: formData
            }).then(r => r.json()).then(j => {
                if (j.ok) {
                    alert('차단 해제되었습니다.');
                    load();
                } else {
                    alert('오류: ' + (j.err || '알 수 없는 오류'));
                }
            }).catch(e => alert(e));
        }
        
        // 포트 차단 해제
        function unblockPort(port) {
            if (!confirm(`포트 ${port}를 차단 해제하시겠습니까?`)) return;
            
            const formData = new FormData();
            formData.append('port', port);
            formData.append('comment', '원클릭 해제');
            formData.append('token', '<?php echo htmlspecialchars(API_TOKEN, ENT_QUOTES, 'UTF-8'); ?>');
            
            fetch('api_unblock_port.php', {
                method: 'POST',
                body: formData
            }).then(r => r.json()).then(j => {
                if (j.ok) {
                    alert('차단 해제되었습니다.');
                    load();
                } else {
                    alert('오류: ' + (j.err || '알 수 없는 오류'));
                }
            }).catch(e => alert(e));
        }
        
        // IP:PORT 차단 해제
        function unblockIPPort(ip, port) {
            if (!confirm(`${ip}:${port}를 차단 해제하시겠습니까?`)) return;
            
            const formData = new FormData();
            formData.append('ip', ip);
            formData.append('port', port);
            formData.append('comment', '원클릭 해제');
            formData.append('token', '<?php echo htmlspecialchars(API_TOKEN, ENT_QUOTES, 'UTF-8'); ?>');
            
            fetch('api_unblock_ipport.php', {
                method: 'POST',
                body: formData
            }).then(r => r.json()).then(j => {
                if (j.ok) {
                    alert('차단 해제되었습니다.');
                    load();
                } else {
                    alert('오류: ' + (j.err || '알 수 없는 오류'));
                }
            }).catch(e => alert(e));
        }
        
        load();
    </script>
</body>

</html>